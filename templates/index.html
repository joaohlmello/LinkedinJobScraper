<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Job Scraper</title>
    <!-- Bootstrap CSS (Replit Dark Theme) -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/job_analysis.css') }}">
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12 d-flex justify-content-between align-items-center">
                <div>
                    <h1>LinkedIn Job Scraper</h1>
                    <p>Extract company information from LinkedIn job listings</p>
                </div>
                <div>
                    <button id="clear-history-btn" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Limpar Histórico
                    </button>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Input Form -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Enter LinkedIn Job URLs</h5>
                    </div>
                    <div class="card-body">
                        <form id="scraper-form">
                            <div class="mb-3">
                                <label for="linkedin_urls" class="form-label">Enter LinkedIn job URLs (one per line):</label>
                                <textarea class="form-control" id="linkedin_urls" name="linkedin_urls" rows="5" placeholder="https://www.linkedin.com/jobs/view/4197948497/..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="ignore_urls" class="form-label">
                                    <span class="badge bg-warning text-dark"><i class="bi bi-slash-circle"></i> Ignorar</span>
                                    URLs a serem ignoradas (uma por linha):
                                </label>
                                <textarea class="form-control" id="ignore_urls" name="ignore_urls" rows="3" placeholder="Coloque aqui URLs que você não quer processar novamente"></textarea>
                                <div class="form-text text-light">
                                    URLs listadas aqui serão ignoradas durante o processamento. Útil para pular vagas já processadas ou irrelevantes.
                                </div>
                            </div>
                            
                            {% if gemini_available %}
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="analyze_jobs" name="analyze_jobs">
                                <label class="form-check-label" for="analyze_jobs">
                                    <span class="badge bg-info"><i class="bi bi-robot"></i> Gemini AI</span>
                                    Analisar compatibilidade das vagas com o currículo usando Gemini AI
                                </label>
                                <div class="form-text text-light">
                                    Esta opção analisará as descrições das vagas e calculará a porcentagem 
                                    de compatibilidade com o currículo pré-configurado. O processo pode levar mais tempo.
                                </div>
                            </div>
                            {% else %}
                            <div class="mb-3">
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                    Análise de compatibilidade com Gemini AI não disponível - 
                                    Chave de API não configurada.
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="batch_size" class="form-label">Tamanho do lote:</label>
                                <select class="form-select" id="batch_size" name="batch_size">
                                    <option value="5">5 URLs por lote</option>
                                    <option value="10" selected>10 URLs por lote</option>
                                    <option value="20">20 URLs por lote</option>
                                    <option value="50">50 URLs por lote</option>
                                </select>
                                <div class="form-text text-light">
                                    Processar em lotes menores é mais rápido e seguro para grandes quantidades de URLs.
                                </div>
                            </div>
                            
                            <button type="submit" id="submit-button" class="btn btn-primary">Extract Information</button>
                        </form>
                        
                        <!-- Barra de Progresso -->
                        <div id="progress-container" class="mt-4 d-none">
                            <h5><i class="bi bi-arrow-repeat spin"></i> <span id="progress-status">Processando...</span></h5>
                            
                            <!-- Progresso do Lote Atual -->
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <small>Progresso do lote atual:</small>
                                    <small><span id="current-batch">0</span>/<span id="total-batches">0</span></small>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                         style="width: 0%">0%</div>
                                </div>
                            </div>
                            
                            <!-- Progresso Total -->
                            <div>
                                <div class="d-flex justify-content-between">
                                    <small>Progresso total:</small>
                                    <small><span id="processed-batches">0</span> lotes processados</small>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div id="total-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                         style="width: 0%">0%</div>
                                </div>
                            </div>
                            
                            <p id="progress-message" class="text-light mt-2">Iniciando processamento em lotes...</p>
                            
                            <!-- Lista de Lotes Processados -->
                            <div id="batches-container" class="mt-3 d-none">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6>Lotes Processados:</h6>
                                    <div class="export-buttons">
                                        <button id="export-selected-batches" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-file-earmark-zip"></i> Exportar lotes selecionados
                                        </button>
                                        <button id="select-all-batches" class="btn btn-outline-secondary btn-sm ms-1">
                                            <i class="bi bi-check-all"></i> Selecionar todos
                                        </button>
                                    </div>
                                </div>
                                <div id="batches-list" class="list-group">
                                    <!-- Os lotes processados serão adicionados aqui dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="mt-4 {% if results_html or has_results %}show{% endif %}">
            {% if results_html %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Results Table</h5>
                            
                            <div class="btn-group">
                                <a href="{{ url_for('export_csv') }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-arrow-down"></i> Download CSV
                                </a>
                                <a href="{{ url_for('export_all_csv') }}" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-file-earmark-zip"></i> Download All CSV
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            {{ results_html|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        {% include 'modals.html' %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/batch_selector.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form submission
            document.getElementById('scraper-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                
                // Get form data
                const formData = new FormData(this);
                const urls = formData.get('linkedin_urls').trim();
                const ignoreUrls = formData.get('ignore_urls').trim();
                const analyzeJobs = formData.get('analyze_jobs') === 'on';
                const batchSize = formData.get('batch_size');
                
                if (!urls) {
                    alert('Please enter at least one LinkedIn job URL.');
                    return;
                }
                
                // Disable form elements
                document.getElementById('submit-button').disabled = true;
                document.querySelectorAll('#scraper-form textarea, #scraper-form select, #scraper-form input').forEach(el => {
                    el.disabled = true;
                });
                
                // Show progress container
                const progressContainer = document.getElementById('progress-container');
                progressContainer.classList.remove('d-none');
                document.getElementById('progress-status').textContent = 'Processando URLs...';
                
                // Send request to process async
                try {
                    const response = await fetch('/process_async', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Set up progress checking interval
                        checkProgressInterval = setInterval(checkProgress, 2000);
                    } else {
                        alert('Error: ' + data.message);
                        resetFormState();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error processing URLs: ' + error.message);
                    resetFormState();
                }
            });
            
            // Clear history button
            document.getElementById('clear-history-btn').addEventListener('click', async function() {
                if (!confirm('Tem certeza que deseja limpar todo o histórico de processamento?\nEsta ação não pode ser desfeita.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/clear_history', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Reload the page
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error clearing history: ' + error.message);
                }
            });
            
            // Function to check progress
            let checkProgressInterval;
            async function checkProgress() {
                try {
                    const response = await fetch('/check_progress', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    
                    // Update the progress bar and status message
                    document.getElementById('progress-bar').style.width = data.progress + '%';
                    document.getElementById('progress-bar').setAttribute('aria-valuenow', data.progress);
                    document.getElementById('progress-bar').textContent = data.progress + '%';
                    document.getElementById('progress-message').textContent = data.message;
                    
                    // Update batches info
                    document.getElementById('current-batch').textContent = data.current_batch;
                    document.getElementById('total-batches').textContent = data.total_batches;
                    document.getElementById('processed-batches').textContent = data.processed_batches;
                    
                    // Update total progress
                    const totalProgressPercent = Math.round((data.processed_batches / data.total_batches) * 100) || 0;
                    document.getElementById('total-progress-bar').style.width = totalProgressPercent + '%';
                    document.getElementById('total-progress-bar').setAttribute('aria-valuenow', totalProgressPercent);
                    document.getElementById('total-progress-bar').textContent = totalProgressPercent + '%';
                    
                    // If processing is complete
                    if (data.status === 'complete') {
                        clearInterval(checkProgressInterval);
                        
                        // If there was a result, show it
                        if (data.has_result) {
                            // Give some time to see the 100% progress
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            resetFormState();
                        }
                    }
                    
                    // Update processed batches list
                    if (data.processed_batches > 0 && data.batches.length > 0) {
                        const batchesContainer = document.getElementById('batches-container');
                        batchesContainer.classList.remove('d-none');
                        
                        const batchesList = document.getElementById('batches-list');
                        updateBatchesList(batchesList, data.batches);
                    }
                } catch (error) {
                    console.error('Error checking progress:', error);
                }
            }
            
            // Function to update the batches list
            function updateBatchesList(batchesList, batches) {
                // Don't rebuild the entire list if elements already exist
                // This avoids deselecting checkboxes when the list is updated
                
                // Create a map of existing items for quick lookup
                const existingItems = {};
                Array.from(batchesList.querySelectorAll('.list-group-item')).forEach(item => {
                    const batchIndex = item.getAttribute('data-batch-index');
                    existingItems[batchIndex] = item;
                });
                
                // Clear the list but keep track of which checkboxes were checked
                const checkedBatches = Array.from(batchesList.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(checkbox => checkbox.getAttribute('data-batch-index'));
                
                // Empty the list
                batchesList.innerHTML = '';
                
                // Add each batch to the list
                batches.forEach(batch => {
                    const batchIndex = batch.index;
                    
                    // Check if this item already existed
                    if (existingItems[batchIndex]) {
                        batchesList.appendChild(existingItems[batchIndex]);
                        return;
                    }
                    
                    // Create a new item
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.setAttribute('data-batch-index', batchIndex);
                    
                    // Create checkbox
                    const checkboxId = `batch-${batchIndex}`;
                    const checkboxLabel = document.createElement('label');
                    checkboxLabel.className = 'd-flex align-items-center gap-2';
                    checkboxLabel.htmlFor = checkboxId;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input batch-checkbox';
                    checkbox.id = checkboxId;
                    checkbox.setAttribute('data-batch-index', batchIndex);
                    
                    // Restore checkbox state if it was checked before
                    if (checkedBatches.includes(batchIndex.toString())) {
                        checkbox.checked = true;
                    }
                    
                    // Create batch info text
                    const batchInfo = document.createElement('span');
                    const createdDate = new Date(batch.created_at);
                    const formattedDate = createdDate.toLocaleString();
                    
                    batchInfo.innerHTML = `
                        Lote ${batchIndex} 
                        <span class="badge bg-primary rounded-pill ms-1">${batch.count} URLs</span>
                        <small class="text-muted ms-2">${formattedDate}</small>
                    `;
                    
                    if (batch.has_error) {
                        batchInfo.innerHTML += ' <span class="badge bg-danger">Erro</span>';
                    }
                    
                    checkboxLabel.appendChild(checkbox);
                    checkboxLabel.appendChild(batchInfo);
                    
                    // Create download button
                    const downloadButton = document.createElement('a');
                    downloadButton.href = `/export_batch_csv/${batchIndex}`;
                    downloadButton.className = 'btn btn-sm btn-outline-primary';
                    downloadButton.innerHTML = '<i class="bi bi-file-earmark-arrow-down"></i> CSV';
                    
                    item.appendChild(checkboxLabel);
                    item.appendChild(downloadButton);
                    
                    batchesList.appendChild(item);
                });
            }
            
            // Reset form state
            function resetFormState() {
                // Re-enable form elements
                document.getElementById('submit-button').disabled = false;
                document.querySelectorAll('#scraper-form textarea, #scraper-form select, #scraper-form input').forEach(el => {
                    el.disabled = false;
                });
            }
            
            // Initial check for progress if the page reloads during processing
            checkProgress();
        });
    </script>
</body>
</html>